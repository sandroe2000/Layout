<div id="editor"></div>
<script>

	var editor = null;

	$(document).ready(function() {
		require(['vs/editor/editor.main'], function () {

			loadSample({
				modeId: getLanguageId(sourceContentInEdition),
				sampleURL: sourceContentInEdition
			});

		});

		window.onresize = resizeEditor();

		function resizeEditor(){
			if (editor) {
				editor.layout();
			}
		}
	});

	function getLanguageId(editFile){

		let ext = editFile.split('.').pop();
		if(ext=='js'){  
			ext = 'javascript';
		}
		return ext;
	}

	var preloaded = {};
	(function() {
		var elements = Array.prototype.slice.call(document.querySelectorAll('pre[data-preload]'), 0);

		elements.forEach(function(el) {
			var path = el.getAttribute('data-preload');
			preloaded[path] = el.innerText || el.textContent;
			el.parentNode.removeChild(el);
		});
	})();

	function xhr(url, cb) {
		if (preloaded[url]) {
			return cb(null, preloaded[url]);
		}

		fetch(sourceContentInEdition)
		.then(function(response) {
			return response.text();
		})
		.then(function(data) {
			cb(null, data);
		});
	}

	function loadSample(mode) {

		$('.loading.editor').show();
		xhr(mode.sampleURL, function(err, data) {
			if (err) {
				if (editor) {
					if (editor.getModel()) {
						editor.getModel().dispose();
					}
					editor.dispose();
					editor = null;
				}
				$('.loading.editor').fadeOut({ duration: 200 });
				$('#editor').empty();
				$('#editor').append('<p class="alert alert-error">Failed to load ' + mode.modeId + ' sample</p>');
				return;
			}

			if (!editor) {
				$('#editor').empty();
				editor = monaco.editor.create(document.getElementById('editor'), {
					model: null,
				});
			}

			var oldModel = editor.getModel();
			var newModel = monaco.editor.createModel(data, mode.modeId);
			editor.setModel(newModel);
			if (oldModel) {
				oldModel.dispose();
			}
			$('.loading.editor').fadeOut({ duration: 300 });
		})
	}

	function loadDiffSample() {

		var onError = function() {
			$('.loading.diff-editor').fadeOut({ duration: 200 });
			$('#diff-editor').append('<p class="alert alert-error">Failed to load diff editor sample</p>');
		};

		$('.loading.diff-editor').show();

		var lhsData = null, rhsData = null, jsMode = null;

		xhr('index/samples/diff.lhs.txt', function(err, data) {
			if (err) {
				return onError();
			}
			lhsData = data;
			onProgress();
		})
		xhr('index/samples/diff.rhs.txt', function(err, data) {
			if (err) {
				return onError();
			}
			rhsData = data;
			onProgress();
		})

		function onProgress() {
			if (lhsData && rhsData) {
				diffEditor = monaco.editor.createDiffEditor(document.getElementById('diff-editor'), {
					enableSplitViewResizing: false
				});

				var lhsModel = monaco.editor.createModel(lhsData, 'text/javascript');
				var rhsModel = monaco.editor.createModel(rhsData, 'text/javascript');

				diffEditor.setModel({
					original: lhsModel,
					modified: rhsModel
				});

				$('.loading.diff-editor').fadeOut({ duration: 300 });
			}
		}
	}

	function changeTheme(theme) {
		var newTheme = (theme === 1 ? 'vs-dark' : ( theme === 0 ? 'vs' : 'hc-black' ));
		monaco.editor.setTheme(newTheme);
	}

</script>